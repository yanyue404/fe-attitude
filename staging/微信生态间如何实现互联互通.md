## 基本概念：unionId 机制

1、请注意，网页授权获取用户基本信息也遵循 UnionID 机制。即如果开发者有在多个公众号，或在公众号、移动应用之间统一用户帐号的需求，需要前往微信开放平台（open.weixin.qq.com）绑定公众号后，才可利用 UnionID 机制来满足上述需求。
2、UnionID 机制的作用说明：如果开发者拥有多个移动应用、网站应用和公众帐号，可通过获取用户基本信息中的 unionid 来区分用户的唯一性，因为同一用户，对同一个微信开放平台下的不同应用（移动应用、网站应用和公众帐号），unionid 是相同的。
通常 unionId 的获取有三种情况：

1. 微信网页强制授权，获取 unionID，需要授权；
2. 微信网页静默授权，传递 openid 给服务端，再调用接口获取用户信息（未关注公众号无法获取 unionId）；
3. 微信小程序使用 wx.login 获取的登录凭证换取 unionID，无需授权；

> 一个公司如果有一个小程序矩阵，同一个用户使用了这 3 个小程序，开发者能够从微信的接口获得到的数据一共有 3 条，3 条数据用户的 openid 是不一致的，但是 unionid 是一致的，openid 和 unionid 都是用户的唯一标示，但是二者唯一性的生成条件是不一致的
>
> - openid 的唯一性=用户微信号+应用的 appid（不同的公众号，小程序，appid 都是不同的）；
> - unionid 的唯一性=用户微信号+开发者主体（一般是公司）

## 授权

### 微信

> 微信网页授权（针对用户在微信内打开对应网页）

- 静默授权
- 强制授权（分两种情况：关注公众号、未关注公众号）

具体网页授权流程分为四步：

1. 引导用户进入授权页面同意授权，获取 code
2. 通过 code 换取网页授权 access_token（与基础支持中的 access_token 不同）
3. 如果需要，开发者可以刷新网页授权 access_token，避免过期
4. 通过网页授权 access_token 和 openid 获取用户基本信息（支持 UnionID 机制）

**详细微信授权流程**

1. 开发者请求客户服务器，获取授权地址

post https://ftest.tk.cn/hera_cloud/api/v2/insure/magicCube/wrapper/authorUrl

- 静默授权 scope 为 snsapi_base 只能获取 access_token 和 openid
- 强制授权 scope 为 snsapi_userinfo 可以获取更详细的用户资料

```json
{
  "refer_url": "refer_url",
  "error_message": "接口成功执行",
  "data": {
    "authorUrl": "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxcd7143c00e5bb6f7&redirect_uri=https://wxpt.taikang.com/tkmap/wechat/oauth2/redirectuser/wxcd7143c00e5bb6f7?other=aHR0cHM6Ly9mdGVzdC50ay5jbi90a3Byb3BlcnR5L25wcmQvTjIwMjEwMDI1Lw&response_type=code&scope=snsapi_userinfo&state=tkonline&connect_redirect=1#wechat_redirect"
  },
  "error_code": "0"
}
```

2. 授权前往微信服务器，同意出发微信授权回调

3. 回调 redirect_uri 客户服务器地址，同时携带 code 参数

同意后重定向，获取 code， https://wxpt.taikang.com/tkmap/wechat/oauth2/redirectuser/wxcd7143c00e5bb6f7?other=aHR0cHM6Ly9mdGVzdC50ay5jbi90a3Byb3BlcnR5L25wcmQvTjIwMjIwMDE1Lw&code=081bu50w3mNRSY2zvo3w3AbwPU0bu50q&state=tkonline

4. 客户服务器使用 code 获取 access_token ，+ openid 拿到用户信息

5. 客户服务器重定向，返回用户信息并拼接到页面地址， https://ftest.tk.cn/tkproperty/nprd/N20210025/?openid=omCIGj8iYAAtKPZwEzIV76LXra1M&state=tkonline&timestamp=20220315104754653&sign=7EA16C8C0E5D4EEB90C8C21F475C2536&userInfo=%7B%22city%22%3A%22%22,%22country%22%3A%22%22,%22headImgUrl%22%3A%22https%3A%2F%2Fthirdwx.qlogo.cn%2Fmmopen%2Fvi_32%2FRvGY4byUjo3B0pC23gjhPSssHsZn7bBWR0z50UyYvSLc27MOg5gfpy30iaDNcsmRwIob4GQbFUkZicHYue24qSUg%2F132%22,%22nickName%22%3A%22yanyue404%22,%22openId%22%3A%22omCIGj8iYAAtKPZwEzIV76LXra1M%22,%22province%22%3A%22%22,%22sex%22%3A%220%22,%22unionId%22%3A%22oKS-Rt50pIXAo0GePdF4sDYS0TsI%22%7D

```json
{
  "openid": "OPENID",
  "nickname": "NICKNAME",
  "sex": 1,
  "province": "PROVINCE",
  "city": "CITY",
  "country": "COUNTRY",
  "headimgurl": "http://wx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0",
  "privilege": ["PRIVILEGE1", "PRIVILEGE2"],
  "unionid": " o6_bmasdasdsad6_2sgVt7hMZOPfL"
}
```

6. 开发者从地址栏解密用户信息，缓存

参考文档：

- https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html
- https://juejin.cn/post/6844903592060780557

### 微信小程序

> 小程序获取用户信息（针对访问小程序的场景）

最新版本的接口中，小程序对于用户基本信息的获取需要调用 wx.getUserProfile 接口，返回加密信息使用 session_key 解密后可以获取到用户昵称、性别、省市等信息；`unionId` 的获取不再需要调用 `wx.getUserInfo` 接口，使用 `wx.login` 获取的登录凭证可以直接换取 `UnionID`；

获取手机号`<button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">授权绑定手机号</button>`，通过用户点击后[bindgetphonenumber](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)事件回调获取的`encryptedData`、`iv`和 `wx.login` 获取的登录凭证可以直接换取 。

最佳实践

> 小程序登录、用户信息相关接口调整说明（公告更新时间：2021 年 04 月 15 日）

调整后，开发者如需获取用户身份标识符只需要调用 wx.login 接口即可。

开发者若需要在界面中展示用户的头像昵称信息，可以通过<open-data>组件进行渲染，该组件无需用户确认，可以在界面中直接展示。

在部分场景（如社交类小程序）中，开发者需要在获取用户的头像昵称信息，可调用 wx.getUserProfile 接口，开发者每次通过该接口均需用户确认，请开发者妥善处理调用接口的时机，避免过度弹出弹窗骚扰用户。

参考文档：

- 小程序登录：https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html
- 小程序用户信息接口调整说明：https://developers.weixin.qq.com/community/develop/doc/000cacfa20ce88df04cb468bc52801

### APP

移动应用微信登录（针对 App 内利用第三方登录访问微信的场景）APP

获取用户信息授权后能拿到的信息:

```json
{
  "openid": "用户的唯一标识",
  "nickname": "",
  "sex": 1,
  "language": "zh_CN",
  "city": "Linfen",
  "province": "Shanxi",
  "country": "CN",
  "headimgurl": "",
  "privilege": [],
  "unionid": "只有用户将公众号绑定到微信开放平台账户后，才会出现该字段"
}
```

参考链接：

- https://zhuanlan.zhihu.com/p/43031807

## 跳转场景

0、小程序内 webview 跳转小程序；

- wx.miniProgram.navigateTo
- wx.miniProgram.switchTab

1、A 小程序跳转 B 小程序；

- 需 B 小程序提供 appId 与页面 Path（点击触发）；

2、A 小程序跳转 H5 页面；

- 需将 H5 页面域名添加至 A 小程序业务域名白名单中；
- 需在 A 小程序中使用 `web-view` 组件包裹；

3、H5 页面跳转 A 小程序；

> 业务场景：发送短链短信给用户，用户点击短链，直接打开 A 小程序，

- 浏览器环境：需配合小程序 `URL Scheme` 工具生成 `Scheme` 链接
- 微信环境：需利用微信的开放标签 `wx-open-launch-weapp` 实现

4、A 小程序 a 页面跳转 B 小程序 b 页面后，直接返回 A 小程序 a 页面；

- 如果 b 页面是 B 小程序的原生页面，直接调用 `wx.navigateBackMiniProgram` 即可；
- 如果 b 页面是 B 小程序中 web-view 嵌入的 H5 页面，需让 b 页面先跳转回 B 小程
  序的原生中转页，再由这个中转页，调用 `wx.navigateBackMiniProgram` 返回 A 小程序

5、公众号的 3\*5 菜单，跳转 A 小程序

- 需要在公众号后台绑定 A 小程序
- 需要 A 小程序的 appId 和 pagePath

## 微信支付

平台：

1. 微信 h5 支付（非微信环境拉起微信支付，链接跳转微信中转页，有兼容问题）
2. 微信公众号支付（链接）
3. 扫码支付（链接转码，一般用与 pc 端展示，引导用户微信扫码）
4. 小程序微信支付
5. APP 微信支付（SDK）
6. 收款码

> 注意：APP 中虚拟商品无法使用 APP 支付，仅可使用微信 h5 支付。微信纯签约后无法返回 APP，默认会打开自带浏览器；普通支付和支付中签约后可以返回 APP（需要 APP 对重定向链接进行拦截）

方式：

1. 普通微信支付
2. 纯签约（根据签约模板区分为多账户和非多账户，现主要为多账户）
3. 支付中签约

官方文档：

- [微信支付- 扣费服务开发者文档](https://pay.weixin.qq.com/wiki/doc/api/wxpay_v2/papay/chapter1_1.shtml)
- [支付回调和查单实现指引- 最佳实践](https://pay.weixin.qq.com/wiki/doc/apiv3/Practices/chapter1_1_1.shtml)
- [产品能力概览 - 基础支付 ](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)

微信 H5 支付常见的问题有以下几种：

1. 网络环境未能通过安全验证，请稍后再试（原因：终端 IP(spbill_create_ip)与用户实际调起支付时微信侧检测到的终端 IP 不一致）
2. 商家参数格式有误，请联系商家解决（原因：当前调起 H5 支付的 referer 为空）
3. 商家存在未配置的参数，请联系商家解决（原因：当前调起 H5 支付的域名与申请 H5 支付时提交的授权域名不一致）
4. 支付请求已失效，请重新发起支付（原因：有效期为 5 分钟，如超时请重新发起支付）
5. 请在微信外打开订单，进行支付（原因：H5 支付不能直接在微信客户端内调起）

更多问题可以参考官方文档：[微信 H5 支付开发指引](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_2.shtml#part-7)

上述问题中问题 2 和 3 比较类似，在 APP 端常见的情况就是跳转微信支付链接的 referer 存在异常，定位问题可以通过抓包获取。

### 微信小程序支付

- 微信纯支付 wx.requestPayment
- 支付中签约
- 微信纯签约

**微信纯签约**

- 1. 跳转签约小程序，签约返回，通过 wx.onAppShow()监听,示例如下：

```js
//具体参数享详见官方文档
wx.navigateToMiniProgram({
  appId: "wxbd687630cd02ce1d",
  path: "pages/index/index",
  extraData, //需要传递给目标小程序的数据
  success: () => {
    //跳转签约小程序标识位置为true
    app.globalData.contractXcxFlag = true;
    resolve();
  },
  fail: (err) => {
    console.log(err);
    this.showToastPro("签约参数异常,无法打开签约小程序");
    reject();
  },
});
wx.onAppShow(res); //res.scene == 1038从签约小程序返回，设置签约状态
```

- 2. 从小程序返回查询签约状态

```js
onShow(){
  let pages = getCurrentPages();
  //有签约号时处理签约逻辑
  this.data.contractData.signPkSubId && this.contractHandler();
}
```

- 3. 已签约后，根据扣费模式，发起扣费，轮询支付状态跳转不同页面（成功页、失败页）

**支付中签约**

同上流程。

## 分享

TODO: 

## 参考链接

- [大前端之路 —— 如何用 Web 技术一统三端开发](https://zhuanlan.zhihu.com/p/30183840)
